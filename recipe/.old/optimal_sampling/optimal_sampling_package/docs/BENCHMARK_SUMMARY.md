# Optimal Sampling åŸºå‡†æµ‹è¯•å¿«é€Ÿæ€»ç»“

## ä¸€å¥è¯æ€»ç»“
åœ¨ Qwen 3B/1.5B æ¨¡å‹ç»„åˆä¸‹ï¼Œ**BS=32, MT=512 é…ç½®è¾¾åˆ°æœ€ä½³ååé‡ 152.68 tok/s**ï¼Œé€‚åˆç”Ÿäº§ç¯å¢ƒæ‰¹é‡æ•°æ®ç”Ÿæˆã€‚

---

## å¿«é€Ÿå¯¹æ¯”è¡¨

| é…ç½®       | æ‰¹é‡ | Tokens | Optimal ååé‡      | Teacher ååé‡ | å»¶è¿Ÿ    | æ¨èåœºæ™¯        |
|----------|----|--------|------------------|-------------|-------|-------------|
| Config 1 | 8  | 256    | 57.70 tok/s      | 1335 tok/s  | 2.97s | âš¡ æµ‹è¯•/è°ƒè¯•     |
| Config 2 | 16 | 512    | 138.81 tok/s     | 2589 tok/s  | 2.37s | â­ **å¹³è¡¡æ¨è**  |
| Config 3 | 32 | 512    | **152.68 tok/s** | 4716 tok/s  | 2.30s | ğŸš€ **æœ€å¤§åå** |
| Config 4 | 16 | 1024   | 119.47 tok/s     | 2333 tok/s  | 3.93s | ğŸ“ é•¿æ¨ç†      |
| Config 5 | 8  | 2048   | 104.31 tok/s     | 1531 tok/s  | 4.51s | ğŸ“š è¶…é•¿æ¨ç†     |

---

## å…³é”®æŒ‡æ ‡

### ååé‡è¶‹åŠ¿
```
57.70 â”€â”€â”¬â”€â”€> 138.81 â”€â”€â”¬â”€â”€> 152.68 (tok/s)
    (BS=8)        (BS=16)      (BS=32)
                                  â†‘
                              æœ€ä½³é…ç½®
```

### é€Ÿåº¦ä»£ä»·
- Optimal Sampling vs Teacher-only: **å¹³å‡æ…¢ 20-30x**
- åŸå› : éœ€è¦è¿è¡Œä¸¤ä¸ªæ¨¡å‹
- ä»·å€¼: é«˜è´¨é‡ semi on-policy æ•°æ®

### å†·å¯åŠ¨ vs çƒ­å¯åŠ¨
- **å†·å¯åŠ¨**: 37.56s (é¦–æ‰¹)
- **çƒ­å¯åŠ¨**: 9.99s (åç»­æ‰¹æ¬¡)
- **æå‡**: **4.5x åŠ é€Ÿ**

---

## ä¸‰å¤§æ¨èé…ç½®

### ğŸ¥‡ æ¨è 1: å¹³è¡¡é…ç½®
```python
batch_size = 16
max_tokens = 512
# ååé‡: 138.81 tok/s
# å»¶è¿Ÿ: 2.37s/req
# é€‚ç”¨: æ—¥å¸¸æ•°æ®ç”Ÿæˆ
```

### ğŸ¥ˆ æ¨è 2: é«˜ååé…ç½®
```python
batch_size = 32
max_tokens = 512
# ååé‡: 152.68 tok/s (æœ€ä½³)
# å»¶è¿Ÿ: 2.30s/req
# é€‚ç”¨: å¤§è§„æ¨¡æ‰¹é‡å¤„ç†
```

### ğŸ¥‰ æ¨è 3: é•¿æ¨ç†é…ç½®
```python
batch_size = 16
max_tokens = 1024
# ååé‡: 119.47 tok/s
# å»¶è¿Ÿ: 3.93s/req
# é€‚ç”¨: è¯¦ç»†æ•°å­¦æ¨ç†
```

---

## æ€§èƒ½ç‰¹ç‚¹

âœ… **ä¼˜åŠ¿**:
- 100% æˆåŠŸç‡ï¼Œç¨³å®šå¯é 
- æ‰¹é‡å¤„ç†æ•ˆç‡é«˜
- Semi on-policy æ•°æ®è´¨é‡ä¼˜ç§€

âš ï¸ **é™åˆ¶**:
- é€Ÿåº¦æ…¢ï¼ˆ20-30x vs teacher-onlyï¼‰
- é¦–æ‰¹å†·å¯åŠ¨å»¶è¿Ÿé«˜ï¼ˆ~40sï¼‰
- éœ€è¦åŒæ¨¡å‹å†…å­˜ï¼ˆ~9GBï¼‰

---

## å®¹é‡ä¼°ç®—ï¼ˆå• GPUï¼‰

| é…ç½® | æ¯å°æ—¶è¯·æ±‚æ•° | æ¯å°æ—¶ç”Ÿæˆ tokens |
|------|-------------|------------------|
| BS=16, MT=512 | ~15,200 | ~5,000,000 |
| BS=32, MT=512 | ~50,000 | ~17,300,000 |
| BS=16, MT=1024 | ~9,200 | ~9,600,000 |

---

## ä½¿ç”¨å»ºè®®

### âœ… é€‚åˆä½¿ç”¨ Optimal Sampling
- ç”Ÿæˆé«˜è´¨é‡è®­ç»ƒæ•°æ®
- Semi on-policy è’¸é¦ä»»åŠ¡
- æ•°å­¦æ¨ç†ã€ä»£ç ç”Ÿæˆç­‰å¤æ‚åœºæ™¯
- å¯¹æ•°æ®è´¨é‡è¦æ±‚é«˜ï¼Œé€Ÿåº¦ä¸æ•æ„Ÿ

### âŒ ä¸é€‚åˆä½¿ç”¨
- å®æ—¶åœ¨çº¿æ¨ç†ï¼ˆç”¨æˆ·ç­‰å¾…ï¼‰
- éœ€è¦å¿«é€Ÿå“åº”çš„æœåŠ¡
- é¢„ç®—/èµ„æºç´§å¼ çš„é¡¹ç›®

---

## å¿«é€Ÿå¼€å§‹

```bash
# å®‰è£…
cd optimal_sampling_package
pip install -e .

# è¿è¡ŒåŸºå‡†æµ‹è¯•
python examples/heavy_benchmark.py

# ä½¿ç”¨æ¨èé…ç½®
python -c "
from optimal_sampling import OptimalSamplingV1

sampler = OptimalSamplingV1(
    model_teacher='Qwen/Qwen2.5-3B-Instruct',
    model_theta='Qwen/Qwen2.5-1.5B-Instruct',
    alpha_method='kl_symmetry',
    track_alpha_stats=False,
)

# æ‰¹é‡ç”Ÿæˆï¼ˆæ¨èé…ç½®ï¼‰
outputs = sampler.generate(
    prompts=teacher_prompts,      # åŒ…å«ç­”æ¡ˆ
    theta_prompts=student_prompts, # ä¸å«ç­”æ¡ˆ
    max_tokens=512,                # å¹³è¡¡ç‚¹
)
"
```

---

## å‚è€ƒæ–‡æ¡£

- **è¯¦ç»†æŠ¥å‘Š**: `BENCHMARK_REPORT.md`
- **åŸå§‹æ•°æ®**: `heavy_benchmark_results.json`
- **è¿è¡Œæ—¥å¿—**: `heavy_benchmark.log`
- **ä½¿ç”¨æŒ‡å—**: `docs/distillation_guide.md`

---

**æµ‹è¯•æ—¥æœŸ**: 2025-11-30
**æµ‹è¯•æ¨¡å‹**: Qwen 3B (teacher) + 1.5B (theta)
**æµ‹è¯•æ–¹æ³•**: KL Symmetry
