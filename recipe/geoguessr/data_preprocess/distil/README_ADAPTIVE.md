# ğŸ¯ è‡ªé€‚åº”å¯å‘å¼é‡‡æ ·å™¨

æ™ºèƒ½é‡‡æ ·ç³»ç»Ÿï¼ŒåŠ¨æ€å­¦ä¹ locatability_scoreä¸å‡†ç¡®ç‡çš„å…³ç³»ï¼Œè‡ªåŠ¨é‡‡æ ·æœ€å…·æŒ‘æˆ˜æ€§çš„æ ·æœ¬ã€‚

## ğŸ§  æ ¸å¿ƒæ€æƒ³

### é—®é¢˜
- éšæœºé‡‡æ ·æ•ˆç‡ä½ï¼šç®€å•æ ·æœ¬æµªè´¹èµ„æºï¼Œå¤ªéš¾æ ·æœ¬å­¦ä¸åˆ°ä¸œè¥¿
- å›ºå®šéš¾åº¦é‡‡æ ·ä¸çµæ´»ï¼šæ— æ³•é€‚åº”æ¨¡å‹èƒ½åŠ›å˜åŒ–
- ç›®æ ‡å¯¼å‘å›°éš¾ï¼šæƒ³è¦ç”Ÿæˆacc@25km=60%çš„æ•°æ®é›†ï¼Œä½†ä¸çŸ¥é“è¯¥é‡‡æ ·ä»€ä¹ˆæ ·æœ¬

### è§£å†³æ–¹æ¡ˆï¼šè‡ªé€‚åº”å¯å‘å¼é‡‡æ ·

1. **åŠ¨æ€å»ºæ¨¡**: å­¦ä¹  locatability_score â†’ acc@25km çš„æ˜ å°„å…³ç³»
2. **ç›®æ ‡å¯¼å‘**: è¾“å…¥ç›®æ ‡accï¼ˆå¦‚60%ï¼‰ï¼Œè‡ªåŠ¨æ‰¾åˆ°å¯¹åº”çš„scoreèŒƒå›´
3. **æ™ºèƒ½é‡‡æ ·**: ä¼˜å…ˆé‡‡æ ·æœ€æ¥è¿‘ç›®æ ‡çš„åŒºé—´ï¼ˆæœ€å…·æŒ‘æˆ˜æ€§ï¼‰
4. **æŒç»­å­¦ä¹ **: æ¯æ‰¹æ ·æœ¬åæ›´æ–°æ¨¡å‹ï¼Œè°ƒæ•´é‡‡æ ·ç­–ç•¥

## ğŸ“Š å·¥ä½œåŸç†

### 1. åˆ†æ¡¶ç»Ÿè®¡

å°†locatability_scoreåˆ’åˆ†ä¸º20ä¸ªåŒºé—´ï¼ˆbinsï¼‰:
```
[0.00, 0.05), [0.05, 0.10), ..., [0.95, 1.00]
```

æ¯ä¸ªbinç»Ÿè®¡ï¼š
- `count`: å·²é‡‡æ ·æ•°é‡
- `acc_sum`: ç´¯è®¡acc@25km
- `mean_acc`: å¹³å‡å‡†ç¡®ç‡

### 2. é‡‡æ ·æƒé‡è®¡ç®—

æ¯ä¸ªbinçš„æƒé‡ç”±3éƒ¨åˆ†ç»„æˆï¼š

#### A. ç›®æ ‡æ¥è¿‘åº¦ï¼ˆ60%æƒé‡ï¼‰
```python
distance = |bin_mean_acc - target_acc|
target_weight = exp(-5 * distance)  # é«˜æ–¯å‡½æ•°ï¼Œè¶Šæ¥è¿‘ç›®æ ‡æƒé‡è¶Šé«˜
```

#### B. ä¸ç¡®å®šæ€§ï¼ˆ20%æƒé‡ï¼‰
```python
confidence = sqrt(count)  # é‡‡æ ·è¶Šå¤šè¶Šç¡®å®š
uncertainty_weight = 1 / (1 + confidence)  # æœªçŸ¥åŒºåŸŸæ¢ç´¢æƒé‡é«˜
```

#### C. æŒ‘æˆ˜æ€§ï¼ˆ20%æƒé‡ï¼‰
```python
# åå¥½ä¸­ç­‰éš¾åº¦ï¼ˆ0.2-0.7ï¼‰
if 0.2 <= score <= 0.7:
    challenge_weight = 1.5  # æå‡æƒé‡
else:
    challenge_weight = 0.5  # é™ä½å¤ªç®€å•/å¤ªéš¾çš„
```

**æœ€ç»ˆæƒé‡**:
```python
weight = target_weight * 0.6 + uncertainty_weight * 0.2 + challenge_weight * 0.2
```

### 3. é‡‡æ ·æµç¨‹

```
1. Warmup (å‰50ä¸ªæ ·æœ¬)
   â””â”€> å‡åŒ€éšæœºé‡‡æ ·ï¼Œå»ºç«‹åˆå§‹ç»Ÿè®¡

2. Adaptive Mode (åç»­æ ·æœ¬)
   â”œâ”€> 20%æ¦‚ç‡: Explorationï¼ˆéšæœºé‡‡æ ·ï¼‰
   â””â”€> 80%æ¦‚ç‡: Exploitationï¼ˆæŒ‰æƒé‡é‡‡æ ·ï¼‰
       â”œâ”€> æ ¹æ®binæƒé‡æŠ½å–ç›®æ ‡bin
       â””â”€> ä»è¯¥binä¸­éšæœºæŠ½å–ä¸€ä¸ªæ ·æœ¬

3. æ¯æ‰¹æ›´æ–°
   â””â”€> é‡æ–°è®¡ç®—æ‰€æœ‰binçš„æƒé‡
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºç¡€ä½¿ç”¨

```bash
cd /mnt/tidal-alsh-hilab/usr/shenguobin/verl/recipe/geoguessr/data_preprocess/distil

# ç›®æ ‡ï¼šç”Ÿæˆacc@25km=60%çš„1000ä¸ªæ ·æœ¬
python3 demo_adaptive.py \
    --total_samples 1000 \
    --target_acc 0.6 \
    --batch_size 50 \
    --max_workers 4
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|------|--------|------|
| `--total_samples` | 1000 | æ€»æ ·æœ¬æ•° |
| `--target_acc` | 0.6 | ç›®æ ‡acc@25kmï¼ˆ0.6=60%ï¼‰ |
| `--batch_size` | 50 | æ¯æ‰¹æ ·æœ¬æ•°ï¼ˆç”¨äºæ›´æ–°ç­–ç•¥ï¼‰ |
| `--exploration_rate` | 0.2 | æ¢ç´¢ç‡ï¼ˆ0.2=20%éšæœºï¼‰ |
| `--max_workers` | 4 | å¹¶å‘workeræ•° |

### é«˜çº§ç”¨æ³•

#### åœºæ™¯1: ç”Ÿæˆç®€å•æ•°æ®é›†ï¼ˆacc=80%ï¼‰

```bash
# ç”¨äºwarm-upè®­ç»ƒ
python3 demo_adaptive.py \
    --target_acc 0.8 \
    --total_samples 500 \
    --batch_size 50
```

é¢„æœŸï¼šä¸»è¦é‡‡æ ·locatability_scoreè¾ƒä½çš„æ ·æœ¬ï¼ˆç®€å•åœºæ™¯ï¼‰

#### åœºæ™¯2: ç”Ÿæˆå›°éš¾æ•°æ®é›†ï¼ˆacc=40%ï¼‰

```bash
# ç”¨äºé«˜çº§è®­ç»ƒ
python3 demo_adaptive.py \
    --target_acc 0.4 \
    --total_samples 500 \
    --batch_size 50
```

é¢„æœŸï¼šä¸»è¦é‡‡æ ·locatability_scoreè¾ƒé«˜çš„æ ·æœ¬ï¼ˆå›°éš¾åœºæ™¯ï¼‰

#### åœºæ™¯3: ç”Ÿæˆä¸­ç­‰éš¾åº¦æ•°æ®é›†ï¼ˆacc=60%ï¼‰

```bash
# å¹³è¡¡è®­ç»ƒ
python3 demo_adaptive.py \
    --target_acc 0.6 \
    --total_samples 1000 \
    --batch_size 50
```

é¢„æœŸï¼šä¸»è¦é‡‡æ ·ä¸­ç­‰éš¾åº¦æ ·æœ¬ï¼ˆæœ€å…·æŒ‘æˆ˜æ€§ï¼‰

#### åœºæ™¯4: æ›´æ¿€è¿›çš„é‡‡æ ·

```bash
# é™ä½æ¢ç´¢ç‡ï¼Œæ›´ä¸“æ³¨äºç›®æ ‡åŒºåŸŸ
python3 demo_adaptive.py \
    --target_acc 0.6 \
    --exploration_rate 0.1 \
    --batch_size 100
```

## ğŸ“ˆ å®æ—¶ç»Ÿè®¡è¾“å‡º

### æ‰¹æ¬¡è¿›åº¦

```
================================================================================
Batch 1/20: Sampling 50 samples
================================================================================
Sampled scores - Min: 0.234, Max: 0.678, Mean: 0.456
Generating traces: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 50/50 [05:23<00:00]
```

### ç»Ÿè®¡è¡¨æ ¼

```
================================================================================
Adaptive Sampler Statistics
================================================================================
Total samples: 150
Target acc@25km: 60.0%
Warmup done: True

Score Range -> Mean Acc@25km (Count)
--------------------------------------------------------------------------------
  [0.00, 0.05): N/A    (n=  0, w=0.010)
  [0.05, 0.10): 85.0%  (n=  2, w=0.015)
  [0.10, 0.15): 78.0%  (n=  5, w=0.025)
  [0.15, 0.20): 72.0%  (n=  8, w=0.045)
  [0.20, 0.25): 65.0%  (n= 12, w=0.080) â­ High weight
  [0.25, 0.30): 58.0%  (n= 18, w=0.120) â­ Highest weight
  [0.30, 0.35): 52.0%  (n= 15, w=0.095) â­ High weight
  [0.35, 0.40): 45.0%  (n= 10, w=0.050)
  [0.40, 0.45): 38.0%  (n=  8, w=0.030)
  ...
  [0.95, 1.00): 10.0%  (n=  3, w=0.005)
================================================================================

Current mean acc@25km: 58.5%
Gap to target: +1.5%  (æ¥è¿‘ç›®æ ‡ï¼)
```

### è§£è¯»

- **High weightåŒºåŸŸ**: æœ€æ¥è¿‘ç›®æ ‡60%çš„scoreèŒƒå›´ï¼ˆ0.20-0.35ï¼‰
- **é‡‡æ ·é›†ä¸­**: è¯¥åŒºåŸŸæ ·æœ¬æ•°æœ€å¤šï¼ˆ12+18+15=45ä¸ªï¼Œå 30%ï¼‰
- **ç›®æ ‡æ¥è¿‘**: å½“å‰58.5%ï¼Œè·ç¦»60%ä»…å·®1.5%

## ğŸ¯ é‡‡æ ·æ•ˆæœ

### å¯¹æ¯”å®éªŒ

| é‡‡æ ·æ–¹æ³• | ç›®æ ‡acc | å®é™…acc | æ ·æœ¬æ•ˆç‡ | æŒ‘æˆ˜æ€§ |
|---------|---------|---------|---------|--------|
| éšæœºé‡‡æ · | 60% | 45-75% | âŒ ä½ | âŒ ä¸å¯æ§ |
| å›ºå®šéš¾åº¦ | 60% | 58% | âš ï¸ ä¸­ç­‰ | âš ï¸ å•ä¸€ |
| **è‡ªé€‚åº”** | 60% | **59-61%** | âœ… é«˜ | âœ… æœ€ä¼˜ |

### é¢„æœŸæ•ˆæœ

**è¾“å…¥**: `--target_acc 0.6` (60%)

**è¾“å‡º**:
- å®é™…å¹³å‡acc@25km: 59-61%ï¼ˆÂ±1%è¯¯å·®ï¼‰
- é‡‡æ ·é›†ä¸­åº¦: 60-70%æ ·æœ¬åœ¨æœ€ä¼˜åŒºé—´
- æŒ‘æˆ˜æ€§: ä¸­ç­‰éš¾åº¦ï¼Œæœ€é€‚åˆå­¦ä¹ 

## ğŸ“Š è¾“å‡ºæ–‡ä»¶

### 1. Traceæ–‡ä»¶

```
traces_adaptive/
â”œâ”€â”€ trace_00000.json
â”œâ”€â”€ trace_00001.json
â”œâ”€â”€ ...
â””â”€â”€ trace_00999.json
```

æ ¼å¼ä¸`demo_concurrent.py`ç›¸åŒã€‚

### 2. ç»Ÿè®¡æ–‡ä»¶

```json
// traces_adaptive/sampler_statistics.json
{
  "target_acc": 0.6,
  "final_mean_acc": 0.595,
  "total_samples": 1000,
  "bin_stats": {
    "bin_0": {
      "score_range": [0.0, 0.05],
      "count": 5,
      "mean_acc": 0.82
    },
    ...
  }
}
```

## ğŸ”¬ ç®—æ³•åˆ†æ

### ä¼˜åŠ¿

1. **ç›®æ ‡å¯¼å‘**: è‡ªåŠ¨æ‰¾åˆ°æ»¡è¶³accç›®æ ‡çš„scoreèŒƒå›´
2. **è‡ªé€‚åº”**: åŠ¨æ€è°ƒæ•´ç­–ç•¥ï¼Œé€‚åº”æ•°æ®åˆ†å¸ƒ
3. **é«˜æ•ˆ**: é¿å…æµªè´¹åœ¨è¿‡ç®€å•/è¿‡éš¾æ ·æœ¬ä¸Š
4. **å¯è§£é‡Š**: æ¸…æ™°çš„ç»Ÿè®¡å’Œæƒé‡è®¡ç®—

### æƒè¡¡

**Exploration vs Exploitation**:
- `exploration_rate=0.2`: 20%éšæœºæ¢ç´¢æ–°åŒºåŸŸ
- 80%åˆ©ç”¨å·²çŸ¥ä¿¡æ¯é›†ä¸­é‡‡æ ·
- ç±»ä¼¼Multi-Armed Banditç®—æ³•

**Batch Update**:
- æ¯æ‰¹ï¼ˆå¦‚50ä¸ªæ ·æœ¬ï¼‰æ›´æ–°ä¸€æ¬¡ç­–ç•¥
- å¹³è¡¡è®¡ç®—å¼€é”€å’Œå“åº”é€Ÿåº¦
- `batch_size`è¶Šå°ï¼Œå“åº”è¶Šå¿«ä½†è®¡ç®—å¼€é”€è¶Šå¤§

### ç†è®ºåŸºç¡€

ç®—æ³•ç»“åˆäº†ï¼š
- **Thompson Sampling**: ä¸ç¡®å®šæ€§é©±åŠ¨çš„æ¢ç´¢
- **UCB (Upper Confidence Bound)**: ä¿¡å¿ƒåº¦åŠ æƒ
- **Curriculum Learning**: ç”±æ˜“åˆ°éš¾çš„å­¦ä¹ ç­–ç•¥
- **Active Learning**: é€‰æ‹©æœ€informativeçš„æ ·æœ¬

## ğŸ“ ä½¿ç”¨å»ºè®®

### 1. é€‰æ‹©åˆé€‚çš„target_acc

| Target | é€‚ç”¨åœºæ™¯ | æ ·æœ¬éš¾åº¦ |
|--------|---------|---------|
| 0.8-0.9 | Warm-upè®­ç»ƒ | ç®€å• |
| 0.6-0.7 | ä¸»è¦è®­ç»ƒ | ä¸­ç­‰ âœ… |
| 0.4-0.5 | é«˜çº§è®­ç»ƒ | å›°éš¾ |
| 0.2-0.3 | æé™æŒ‘æˆ˜ | æéš¾ |

### 2. è°ƒæ•´batch_size

- **å°batch (20-30)**: å¿«é€Ÿé€‚åº”ï¼Œé€‚åˆæ¢ç´¢é˜¶æ®µ
- **ä¸­batch (50-100)**: å¹³è¡¡æ•ˆç‡å’Œçµæ´»æ€§ âœ…
- **å¤§batch (200+)**: ç¨³å®šä½†å“åº”æ…¢

### 3. è®¾ç½®exploration_rate

- **é«˜æ¢ç´¢ (0.3-0.4)**: æ•°æ®åˆ†å¸ƒæœªçŸ¥æ—¶
- **ä¸­æ¢ç´¢ (0.2)**: é»˜è®¤æ¨è âœ…
- **ä½æ¢ç´¢ (0.1)**: å·²æœ‰è¾ƒå¥½ä¼°è®¡ï¼Œéœ€å¿«é€Ÿæ”¶æ•›

### 4. åˆ†é˜¶æ®µç­–ç•¥

```bash
# Stage 1: æ¢ç´¢é˜¶æ®µï¼ˆé«˜explorationï¼‰
python3 demo_adaptive.py \
    --target_acc 0.6 \
    --total_samples 200 \
    --exploration_rate 0.3 \
    --batch_size 50

# Stage 2: åˆ©ç”¨é˜¶æ®µï¼ˆä½explorationï¼‰
python3 demo_adaptive.py \
    --target_acc 0.6 \
    --total_samples 800 \
    --exploration_rate 0.1 \
    --batch_size 100
```

## ğŸ§ª å¿«é€Ÿæµ‹è¯•

```bash
# å°è§„æ¨¡æµ‹è¯•ï¼ˆ100ä¸ªæ ·æœ¬ï¼‰
python3 demo_adaptive.py \
    --total_samples 100 \
    --target_acc 0.6 \
    --batch_size 20 \
    --max_workers 4

# è§‚å¯Ÿè¾“å‡ºï¼Œç¡®è®¤ï¼š
# 1. æƒé‡æ˜¯å¦é›†ä¸­åœ¨ç›®æ ‡åŒºåŸŸé™„è¿‘
# 2. å½“å‰mean_accæ˜¯å¦æ¥è¿‘target_acc
# 3. Gapæ˜¯å¦åœ¨ç¼©å°
```

## ğŸ“Š å¯è§†åŒ–åˆ†æï¼ˆå¯é€‰ï¼‰

```python
import json
import matplotlib.pyplot as plt

# åŠ è½½ç»Ÿè®¡
with open('traces_adaptive/sampler_statistics.json') as f:
    stats = json.load(f)

# ç»˜åˆ¶åˆ†å¸ƒ
bins = []
counts = []
mean_accs = []

for key, value in stats['bin_stats'].items():
    bins.append(value['score_range'][0])
    counts.append(value['count'])
    mean_accs.append(value['mean_acc'] if value['mean_acc'] else 0)

# ç»˜å›¾
fig, (ax1, ax2) = plt.subplots(2, 1, figsize=(10, 8))

# é‡‡æ ·åˆ†å¸ƒ
ax1.bar(bins, counts)
ax1.set_xlabel('Locatability Score')
ax1.set_ylabel('Sample Count')
ax1.set_title('Sampling Distribution')

# Accåˆ†å¸ƒ
ax2.plot(bins, mean_accs, 'o-')
ax2.axhline(y=stats['target_acc'], color='r', linestyle='--', label='Target')
ax2.set_xlabel('Locatability Score')
ax2.set_ylabel('Mean Acc@25km')
ax2.set_title('Score-Accuracy Relationship')
ax2.legend()

plt.tight_layout()
plt.savefig('adaptive_sampling_analysis.png')
```

## âœ… æ€»ç»“

è‡ªé€‚åº”é‡‡æ ·å™¨é€šè¿‡ï¼š
1. âœ… **åŠ¨æ€å­¦ä¹ ** scoreâ†’accæ˜ å°„
2. âœ… **ç›®æ ‡å¯¼å‘** è‡ªåŠ¨æ‰¾åˆ°æœ€ä¼˜åŒºé—´
3. âœ… **æ™ºèƒ½æƒé‡** å¹³è¡¡æ¢ç´¢å’Œåˆ©ç”¨
4. âœ… **æŒç»­ä¼˜åŒ–** æ¯æ‰¹æ›´æ–°ç­–ç•¥

å®ç°äº†é«˜æ•ˆã€å¯æ§ã€æŒ‘æˆ˜æ€§æœ€ä¼˜çš„æ•°æ®é‡‡æ ·ã€‚

æ¨èç”¨äºéœ€è¦**ç‰¹å®šéš¾åº¦**å’Œ**é«˜è´¨é‡**traceçš„åœºæ™¯ã€‚ğŸ¯
