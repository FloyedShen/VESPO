# åˆ†å¸ƒå¼æ•°æ®åŠ è½½å®ç°

è¿™ä¸ªç›®å½•åŒ…å«åˆ†å¸ƒå¼ DataLoader çš„å®Œæ•´å®ç°ã€‚

## ğŸ“ ç›®å½•ç»“æ„

```
dist_data/
â”œâ”€â”€ README.md                          # æœ¬æ–‡ä»¶
â”œâ”€â”€ geoguessr_dataset_distributed.py   # æ”¯æŒæ•°æ®åˆ†ç‰‡çš„ Dataset
â”œâ”€â”€ test_phase1_data_sharding.py       # Phase 1: æ•°æ®åˆ†ç‰‡æµ‹è¯•
â”œâ”€â”€ test_phase2_ray_workers.py         # Phase 2: Ray workers æµ‹è¯• (å¾…åˆ›å»º)
â”œâ”€â”€ worker_with_dataloader.py          # Phase 3: Worker é›†æˆ DataLoader (å¾…åˆ›å»º)
â””â”€â”€ full_implementation/                # Phase 4-5: å®Œæ•´å®ç° (å¾…åˆ›å»º)
```

## ğŸš€ å®æ–½è¿›åº¦

### âœ… Phase 1: Dataset æ•°æ®åˆ†ç‰‡æ”¯æŒ
- [x] åˆ›å»º `GeoguessrRLHFDatasetDistributed`
- [x] å®ç°æ•°æ®åˆ†ç‰‡é€»è¾‘
- [ ] è¿è¡Œæµ‹è¯•éªŒè¯

### â³ Phase 2: Ray åˆ†å¸ƒå¼ Workers éªŒè¯
- [ ] åˆ›å»º Ray actors æµ‹è¯•
- [ ] éªŒè¯æ•°æ®ä¸é‡å¤
- [ ] æµ‹è¯•å†…å­˜å ç”¨

### â³ Phase 3: Worker æœ¬åœ° DataLoader
- [ ] å®ç° Worker é›†æˆ DataLoader
- [ ] å¤„ç†æ•°æ®æ ¼å¼è½¬æ¢
- [ ] æµ‹è¯•æ•°æ®åŠ è½½æµç¨‹

### â³ Phase 4: è®­ç»ƒå¾ªç¯é›†æˆ
- [ ] ä¿®æ”¹è®­ç»ƒå¾ªç¯æ”¯æŒåˆ†å¸ƒå¼åŠ è½½
- [ ] å¤„ç† PPO æ•°æ®æµ
- [ ] æ±‡æ€» worker è¾“å‡º

### â³ Phase 5: å®Œæ•´æµ‹è¯•
- [ ] ç«¯åˆ°ç«¯æµ‹è¯•
- [ ] æ€§èƒ½æµ‹è¯•
- [ ] å†…å­˜éªŒè¯

## ğŸ“ ä½¿ç”¨è¯´æ˜

### Phase 1: æµ‹è¯•æ•°æ®åˆ†ç‰‡

```bash
cd /mnt/tidal-alsh-hilab/usr/shenguobin/verl/recipe/geoguessr/dist_data
source /mnt/tidal-alsh-hilab/usr/shenguobin/verl/.venv/bin/activate

# ä¿®æ”¹ test_phase1_data_sharding.py ä¸­çš„æ•°æ®è·¯å¾„
# ç„¶åè¿è¡Œæµ‹è¯•
python test_phase1_data_sharding.py
```

### é…ç½®æ•°æ®è·¯å¾„

åœ¨æµ‹è¯•è„šæœ¬ä¸­ä¿®æ”¹ï¼š
```python
data_files = [
    "ä½ çš„æ•°æ®è·¯å¾„/train_data.parquet"  # ä¿®æ”¹è¿™é‡Œ
]
```

## ğŸ¯ è®¾è®¡ç›®æ ‡

### å†…å­˜ä¼˜åŒ–
- **å½“å‰**: å•æœº 1.45 TB (batch_size=8192)
- **ç›®æ ‡**: 16 GB per node (åˆ†å¸ƒå¼åˆ° 64 nodes)
- **é™ä½**: 90 å€

### æ¶æ„å˜åŒ–
```
ä¹‹å‰:
TaskRunner (å•æœº) â†’ DataLoader â†’ 64 GPU workers
    â†‘ ç“¶é¢ˆï¼

ä¹‹å:
GPU Worker 1 â†’ æœ¬åœ° DataLoader â†’ æ¨¡å‹
GPU Worker 2 â†’ æœ¬åœ° DataLoader â†’ æ¨¡å‹
...
GPU Worker 64 â†’ æœ¬åœ° DataLoader â†’ æ¨¡å‹
    â†‘ å®Œå…¨åˆ†å¸ƒå¼ï¼
```

## ğŸ¤ åä½œæ–¹å¼

1. **æˆ‘è´Ÿè´£**: ç¼–å†™æ‰€æœ‰ä»£ç 
2. **ä½ è´Ÿè´£**:
   - è¿è¡Œæµ‹è¯•è„šæœ¬
   - æä¾›é”™è¯¯ä¿¡æ¯
   - éªŒè¯ç»“æœ
   - æä¾›æ•°æ®è·¯å¾„ç­‰é…ç½®ä¿¡æ¯

## ğŸ“Š é¢„æœŸæ”¶ç›Š

| æŒ‡æ ‡ | å½“å‰ | ç›®æ ‡ | æ”¹å–„ |
|------|------|------|------|
| å•æœºå†…å­˜ | 1.45 TB | 16 GB | 90x â†“ |
| ç½‘ç»œä¼ è¾“ | 248 GB/batch | 0 GB | 100% â†“ |
| æ‰©å±•æ€§ | å—é™ | ä¼˜ç§€ | âœ… |
| batch_size | 2048 (é™åˆ¶) | 8192+ | 4x â†‘ |

## âš ï¸ æ³¨æ„äº‹é¡¹

- âœ… æ‰€æœ‰æµ‹è¯•è„šæœ¬åªä½¿ç”¨ CPUï¼ˆä¸å ç”¨ GPUï¼‰
- âœ… å¯ä»¥åœ¨è®­ç»ƒè¿›è¡Œæ—¶è¿è¡Œæµ‹è¯•
- âœ… é€æ­¥éªŒè¯ï¼Œæ¯ä¸ª Phase ç‹¬ç«‹æµ‹è¯•

## ğŸ“ é‡åˆ°é—®é¢˜ï¼Ÿ

1. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
2. æä¾›å®Œæ•´çš„é”™è¯¯ä¿¡æ¯ç»™æˆ‘
3. æˆ‘ä¼šç«‹å³ä¿®å¤å¹¶æ›´æ–°ä»£ç 

---

**å½“å‰çŠ¶æ€**: Phase 1 å¼€å‘å®Œæˆï¼Œç­‰å¾…æµ‹è¯•éªŒè¯ âœ¨
